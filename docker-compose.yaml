services:
  # PostgreSQL database
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: washing_line_monitor
      POSTGRES_USER: ${DB_USER}      # Use environment variable
      POSTGRES_PASSWORD: ${DB_PASSWORD}  # Use environment variable
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./schema.sql:/docker-entrypoint-initdb.d/schema.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d washing_line_monitor"]
      interval: 10s
      timeout: 5s
      retries: 5
  glances:
    image: nicolargo/glances:latest
    container_name: glances
    restart: always
    ports:
      - "61208:61208"
    environment:
      # This allows Glances to run its web server mode automatically
      - "GLANCES_OPT=-w" 
    volumes:
      # Essential: Allows Glances to see host system stats
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Optional: Allows Glances to see host disk usage/paths
      - /:/host:ro
    pid: host # Essential: Allows Glances to see processes running in other containers

  # Your Rust application
  app:
    build: .
    ports:
      - "8000:8000"
    environment:
      ROCKET_DATABASES: '{postgres={url="${DATABASE_URL}"}}'
      ROCKET_ADDRESS: 0.0.0.0
      RUST_BACKTRACE: full
      NTFY_TOPIC: ${NTFY_TOPIC}
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  debug:
    image: nicolaka/netshoot
    command: sleep infinity
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    profiles:
      - debug
    depends_on:
      - postgres


volumes:
  postgres_data: